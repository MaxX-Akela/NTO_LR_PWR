<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Панель управления миссией</title>
    <script src="https://unpkg.com/roslib/build/roslib.min.js"></script>
    <script src="https://unpkg.com/three/build/three.js"></script>
    <script src="https://unpkg.com/ros3d/build/ros3d.min.js"></script>

    <style>
        body { font-family: Arial; margin: 20px; }
        .top-panel { display:flex; gap:10px; margin-bottom:20px; }
        #map { border:1px solid #000; width:500px; height:500px; background:#fafafa; }

        #rviz_view {
            width: 600px;
            height: 400px;
            border: 2px solid #333;
            margin-top: 20px;
        }
        #ros_status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .status-connected { color: green; }
        .status-error, .status-closed { color: red; }
    </style>
</head>
<body>

    <h2>Панель управления миссией</h2>

    <div id="ros_status">Статус ROS: <span id="ros_connection_status">Ожидание...</span></div>

    <div class="top-panel">
        <button onclick="sendCommand('start')">START</button>
        <button onclick="sendCommand('stop')">STOP</button>
        <button onclick="sendCommand('kill')">KILL SWITCH</button>
    </div>

    <div>
        <h3>Найденные врезки:</h3>
        <pre id="tubes_list">—</pre>
    </div>

    <h3>Карта (локальная)</h3>
    <canvas id="map"></canvas>

    <h3>RVIZ</h3>
    <div id="rviz_view"></div>

    <script>
        const ROS_WEBSOCKET_URL = "ws://localhost:9090";
        const MAP_SCALE_FACTOR = 20;
        const UPDATE_INTERVAL_MS = 500;

        function sendCommand(cmd) {
            fetch(`/command/${cmd}`, {method: "POST"})
                .then(r => r.text())
                .then(t => console.log("CMD:", t))
                .catch(e => console.error("Ошибка при отправке команды:", e));
        }

        function updateData() {
            fetch("/tubes.json")
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    document.getElementById("tubes_list").innerText = JSON.stringify(data, null, 2);
                    drawMap(data);
                })
                .catch(e => {
                    console.error("Ошибка при загрузке данных (/tubes.json):", e);
                    document.getElementById("tubes_list").innerText = "Ошибка загрузки данных.";
                });
        }

        function drawMap(data) {
            const c = document.getElementById("map");
            const ctx = c.getContext("2d");
            
            const centerX = c.width / 2;
            const centerY = c.height / 2;

            ctx.clearRect(0, 0, c.width, c.height);

            ctx.fillStyle = "black";
            ctx.fillText("0,0", centerX - 10, centerY + 10);

            ctx.strokeStyle = "blue";
            ctx.lineWidth = 4;
            if (data.pipeline && data.pipeline.length > 0) {
                ctx.beginPath();
                ctx.moveTo(data.pipeline[0].x * MAP_SCALE_FACTOR + centerX, data.pipeline[0].y * (-MAP_SCALE_FACTOR) + centerY);
                for (let p of data.pipeline) {
                    ctx.lineTo(p.x * MAP_SCALE_FACTOR + centerX, p.y * (-MAP_SCALE_FACTOR) + centerY);
                }
                ctx.stroke();
            }

            ctx.fillStyle = "red";
            if (data.tubes) {
                for (let t of data.tubes) {
                    ctx.beginPath();
                    ctx.arc(t.x * MAP_SCALE_FACTOR + centerX, t.y * (-MAP_SCALE_FACTOR) + centerY, 6, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
        }

        setInterval(updateData, UPDATE_INTERVAL_MS);

        const statusElement = document.getElementById("ros_connection_status");

        const ros = new ROSLIB.Ros({
            url: ROS_WEBSOCKET_URL
        });

        ros.on('error', (error) => {
            console.error("Ошибка ROS-соединения:", error);
            statusElement.innerText = "ОШИБКА";
            statusElement.className = "status-error";
        });

        ros.on('connection', () => {
            console.log("Соединение с rosbridge установлено.");
            statusElement.innerText = "Подключено";
            statusElement.className = "status-connected";
        });

        ros.on('close', () => {
            console.log("Соединение с rosbridge закрыто.");
            statusElement.innerText = "Отключено";
            statusElement.className = "status-closed";
        });

        const viewer = new ROS3D.Viewer({
            divID: "rviz_view",
            width: 600,
            height: 400,
            antialias: true
        });

        viewer.scene.add(new THREE.AmbientLight(0x404040));
        viewer.scene.add(new THREE.DirectionalLight(0xffffff, 0.5));
        
        const tfClient = new ROSLIB.TFClient({
            ros : ros,
            fixedFrame : "aruco_map",
            angularThres : 0.01,
            transThres : 0.01,
            rate : 10
        });

        const markerClient = new ROS3D.MarkerClient({
            ros : ros,
            tfClient : tfClient,
            topic : "/pipeline_markers",
            rootObject : viewer.scene
        });

    </script>

</body>
</html>
